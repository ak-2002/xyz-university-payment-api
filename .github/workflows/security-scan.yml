name: Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install security tools
      run: |
        dotnet tool install --global dotnet-outdated-tool
        dotnet tool install --global dotnet-security-scan

    - name: Check for outdated packages
      run: |
        dotnet outdated xyz-university-payment-api/xyz-university-payment-api.csproj --fail-on-updates

    - name: Check for vulnerable packages
      run: |
        dotnet list xyz-university-payment-api/xyz-university-payment-api.csproj package --vulnerable

    - name: Run security scan
      run: |
        dotnet security-scan xyz-university-payment-api/xyz-university-payment-api.csproj

    - name: Run SAST scan with CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: csharp

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3 